////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Created: 25.11.2023
// Author: Deathman
// Nocturning studio for NS Project X
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#include "common.h"
#include "gbuffer.h"
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Pixel
vector4 main (vector2 TexCoords: TEXCOORD0): COLOR
{
    vector depth = GetPosition (TexCoords).z;
	vector4 distort = tex2Dlod0 (s_distort, TexCoords);
	vector2 offset = (distort.xy - (127.0h / 255.0h)) * def_distort; // fix newtral offset
	vector2 SampleTexCoords = TexCoords + offset;
    vector depth_x = GetPosition (SampleTexCoords).z;
    if ((depth_x + EPSDEPTH) < depth)	
        SampleTexCoords = TexCoords; // discard new sample
    
    vector3 image = tex2Dlod0 (s_image, SampleTexCoords);

 	vector3 blurred = def_hdr;
    image = lerp (image, blurred, distort.z);

    return image.rgbb;
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
