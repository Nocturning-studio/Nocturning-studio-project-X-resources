#include "common.h"
#include "gbuffer.h"
#include "fog.h"

struct v2p
{
 	vector2 tc0: TEXCOORD0; // base
	vector4 c: COLOR0; // diffuse

#ifdef	USE_SOFT_PARTICLES
//	Igor: for additional depth dest
	vector4 tctexgen	: TEXCOORD1;
#endif	//	USE_SOFT_PARTICLES
	
	vector3 position: TEXCOORD2;
};

struct PixelShaderOutputStruct
{
	vector4 Generic_0: COLOR0;
	vector4 Position: COLOR1;
};
//////////////////////////////////////////////////////////////////////////////////////////
PixelShaderOutputStruct main (v2p I)
{
	vector4 distort = tex2D (s_distort, I.tc0);
    vector factor = distort.a * dot (I.c.rgb, 0.33h);

#ifdef	USE_SOFT_PARTICLES
	vector2	zero = vector2( 0.5, 0.5);
	vector	alphaDistort;
	vector Depth = GetPositionProjected(I.tctexgen).z;
	vector spaceDepth = Depth - I.tctexgen.z;
	alphaDistort = saturate(1.3*spaceDepth);
	distort.xy = lerp  ( zero, distort.xy, alphaDistort);
#endif	//	USE_SOFT_PARTICLES

	// Deathman - считаем туман второй раз, но теперь специально для этого конкретного объекта
    FogComponents Fog = CalcFog (I.position);
    distort.rgb = lerp (distort.rgb, Fog.Color, Fog.Fogness);
    vector Opacity = (1.0h - pow (Fog.Fogness, 2)) * factor;
	
    PixelShaderOutputStruct Output;
    Output.Generic_0 = vector4 (distort.rgb, Opacity);
    Output.Position = vector4 (I.position, xmaterial);
    return Output;
}
