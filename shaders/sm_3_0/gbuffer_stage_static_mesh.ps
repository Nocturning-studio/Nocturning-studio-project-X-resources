///////////////////////////////////////////////////////////////////////////////////
// Created: 06.08.2023
// Author: Deathman
// Nocturning studio for NS Project X
///////////////////////////////////////////////////////////////////////////////////
#include "common.h"
#include "gbuffer.h"
#include "material.h"
#include "lightmap.h"
#include "alpha_test.h"
///////////////////////////////////////////////////////////////////////////////////
struct Interpolators
{
	float4 HomogeniousPosition: POSITION;
	float3 Position: TEXCOORD0;
	float3 TBN0: TEXCOORD1;
	float3 TBN1: TEXCOORD2;
	float3 TBN2: TEXCOORD3;
	float2 UV: TEXCOORD4;
	float2 LightMapUV: TEXCOORD5;
	float Lighting: TEXCOORD6;
	float2 vpos : VPOS;
};
// uniform sampler2D s_albedo;
///////////////////////////////////////////////////////////////////////////////////
GBufferPacked main (Interpolators Input)
{
    GBuffer GBuffer;
	
	// Combine TBN for send to material loading
	float3x3 TBN = float3x3 (Input.TBN0, Input.TBN1, Input.TBN2);

	// Load primary material data - textures, displacement, normal data preparing, etc
    MaterialParams Material = GetMaterial (Input.UV, TBN, Input.Position);

#ifdef USE_ALPHA_TEST
	calc_alpha_test(Input.UV, Material.Opacity);
#endif

    GBuffer.Albedo = Material.Albedo;
	
//#ifdef USE_ALPHA_TEST
//	float2 tc = Input.vpos / float2(1024, 768);
//	float4 old = tex2D(s_albedo, tc);
//    GBuffer.Albedo = Material.Albedo * 0.5 + old * 0.5;
//#endif

    GBuffer.Normal = normalize (mul (TBN, Material.Normal)).rgb;

	// Multiply by heightmap for create some "bias" for light calculating and avoiding acne 
    GBuffer.Position = Input.Position;

#ifdef USE_POSITION_WITH_NORMALS_BIAS
    GBuffer.Position += GBuffer.Normal * Material.Height * 0.015f;
#endif
	
#ifdef USE_LIGHTMAP
	// Get and separate static light data
	LightMapData LightMap;
	LightMap = Unpack_LightMap(Input.LightMapUV);

	GBuffer.AO = LightMap.AO;
#else//USE_LIGHTMAP
    GBuffer.AO = Input.Lighting.x * (AO_BRIGHTNESS - 0.25f);
#endif//USE_LIGHTMAP

	// Apply baked ao for light map ao
    GBuffer.BakedAO = Material.AO;

    GBuffer.Glossiness = Material.Glossiness;
	
    GBufferPacked Output = PackGBuffer (GBuffer);
    return Output;
}
///////////////////////////////////////////////////////////////////////////////////
