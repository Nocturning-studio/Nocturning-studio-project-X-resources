//////////////////////////////////////////////////////////////////////////////////////////
//	Created		: 19.12.2023
//	Author		: Deathman
//	NSProjectX Nocturning Studio - 2023
//////////////////////////////////////////////////////////////////////////////////////////
// Depth based ambient occlusion filter from X-Ray Engine 2.0
//////////////////////////////////////////////////////////////////////////////////////////
#include "common.h"
#include "gbuffer.h"
//////////////////////////////////////////////////////////////////////////////////////////
float4 main(float2 TexCoords: TEXCOORD0): COLOR
{
    float center_depth = GetDepth(TexCoords);
    float ao_sum = 0.0h;
    float total_weight = 0.0h;

    for (int i = -3; i < 3; i++)
    {
        float2 sample_uv = TexCoords + float2 (0.0h, i + 0.5h) / screen_res.xy;
        
        float sample_ao = tex2Dlod0 (s_ao, sample_uv).r;
        float sample_depth = GetDepth(sample_uv);

        float depth_result = 1.0h - saturate (pow ((sample_depth - center_depth), 2.0h) / (0.001h * center_depth)) + 0.2h;

        total_weight += depth_result;

        ao_sum += sample_ao * depth_result;
    }

    return ao_sum / total_weight;
}
//////////////////////////////////////////////////////////////////////////////////////////
