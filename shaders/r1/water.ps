#include "common.h"

struct v2p
{
    float2 tbase: TEXCOORD0; // base
    float3 tenv: TEXCOORD1; // env
    float4 c0: COLOR0;
    float fog: FOG;
};


////////////////////////////////////////////////////////////////////////////////
// Pixel
float4 main (v2p I): COLOR
{

    float4 t_base = tex2D (s_base, I.tbase);
    float3 t_env = texCUBE (s_env, I.tenv);

    float3 refl = lerp (t_env, t_base, I.c0.a);
    float3 color = lerp (refl, t_base, t_base.a);
    float3 final = color * I.c0 * 2;

    float alpha_shift = saturate (.5 - I.c0.a);
    float alpha_add = alpha_shift * alpha_shift;
    float alpha = t_base.a;
	
    final = ApplyFogness (final, I.fog);
	// out
    return float4 (final, t_base.a);
}
