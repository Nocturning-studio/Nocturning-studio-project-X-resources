#include "common.h"

struct v2p
{
    float2 tc0: TEXCOORD0; // base0
    float2 tc1: TEXCOORD1; // base1
    float2 tc2: TEXCOORD2; // hemi0
    float2 tc3: TEXCOORD3; // hemi1
    float4 c: COLOR0; // color
    float4 f: COLOR1; // color
    //float fog: COLOR2;
};
//////////////////////////////////////////////////////////////////////////////////////////
// Pixel
uniform_sampler2D(s_base0, smp_base);
uniform_sampler2D(s_base1, smp_base);
uniform_sampler2D(s_hemi0, smp_linear);
uniform_sampler2D(s_hemi1, smp_linear);
float4 main (v2p I):SV_Target
{
    float4 base0 = tex2D (s_base0, I.tc0);
    float4 base1 = tex2D (s_base1, I.tc1);
    float4 hemi0 = tex2D (s_hemi0, I.tc2) * 0.5;
    float4 hemi1 = tex2D (s_hemi1, I.tc3) * 0.5;

    float4 base = lerp (base0, base1, I.f.w) * I.c;
	
	// alpha test
	// clip(base.a - (96.f/255.f));
  
    float hemi = lerp (hemi0, hemi1, I.f.w).w;

    float3 color = base * 2 * (0.5 + 0.5 * hemi);
	float val = 0.5;
	float alpha = base.a + val;
	alpha = sqrt(mad(alpha, alpha, -val));
    //color = ApplyFogness (color, I.fog);
    
    color = CalcTonemap (color);
    
    return float4 (color, alpha);
}
